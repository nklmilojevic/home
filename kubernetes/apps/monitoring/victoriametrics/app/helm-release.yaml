---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vmetrics
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      # renovate: registryUrl=https://victoriametrics.github.io/helm-charts chart=victoria-metrics-single
      version: 0.18.1
      sourceRef:
        kind: HelmRepository
        name: victoriametrics
        namespace: flux-system
  values:
    nameOverride: ""
    fullnameOverride: ""
    tenant: "0"
    argocdReleaseOverride: ""

    victoria-metrics-operator:
      enabled: true
      cleanupCRD: true
      cleanupImage:
        repository: gcr.io/google_containers/hyperkube
        tag: v1.18.6
        pullPolicy: IfNotPresent

      createCRD: false # we disable crd creation by operator chart as we create them in this chart
      operator:
        disable_prometheus_converter: false

    serviceAccount:
      create: true
      annotations: {}

    defaultRules:
      create: true
      rules:
        etcd: true
        general: false
        k8s: true
        kubeApiserver: true
        kubeApiserverAvailability: true
        kubeApiserverBurnrate: true
        kubeApiserverSlos: true
        kubelet: true
        kubePrometheusGeneral: true
        kubePrometheusNodeRecording: true
        kubernetesApps: true
        kubernetesResources: false
        kubernetesStorage: true
        kubernetesSystem: true
        kubeScheduler: true
        kubeStateMetrics: true
        network: true
        node: true
        vmagent: false
        vmsingle: false
        vmhealth: false
        alertmanager: false

      runbookUrl: https://runbooks.prometheus-operator.dev/runbooks
      appNamespacesTarget: ".*"

    defaultDashboardsEnabled: true
    experimentalDashboardsEnabled: true

    vmsingle:
      annotations: {}
      enabled: true
      # spec for VMSingle crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmsinglespec
      spec:
        image:
          # renovate: datasource=docker depName=victoriametrics/victoria-metrics
          tag: v1.93.5
        retentionPeriod: "14"
        replicaCount: 1
        extraArgs: {}

    alertmanager:
      enabled: true
      annotations: {}
      # spec for VMAlertmanager crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmalertmanagerspec
      spec:
        resources:
          limits:
            cpu: 200m
            memory: 200Mi
          requests:
            cpu: 200m
            memory: 100Mi
        selectAllByDefault: true
        image:
          tag: v0.24.0
        externalURL: ""
        routePrefix: /

      monzoTemplate:
        enabled: false

      config:
        global:
          resolve_timeout: 5m
        route:
          group_by: ["alertname"]
          group_wait: 1m
          group_interval: 5m
          repeat_interval: 3h
          receiver: devnull
          routes:
            - receiver: blackhole
              matchers:
                - "severity=blackhole"
              continue: false
        receivers:
          - name: devnull
          - name: blackhole

    vmalert:
      enabled: true
      remoteWriteVMAgent: false
      # spec for VMAlert crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmalertspec
      spec:
        selectAllByDefault: true
        image:
          # renovate: datasource=docker depName=victoriametrics/vmalert
          tag: v1.94.0
        evaluationInterval: 15s

    vmagent:
      enabled: true
      # https://docs.victoriametrics.com/operator/api.html#vmagentremotewritespec
      # defined spec will be added to the remoteWrite configuration of VMAgent
      spec:
        image:
          # renovate: datasource=docker depName=victoriametrics/vmagent
          tag: v1.94.0
        resources:
          limits:
            cpu: 2000m
            memory: 500Mi
          requests:
            cpu: 50m
            memory: 200Mi
        inlineScrapeConfig: |
          - job_name: node-exporter
            honor_labels: true
            scrape_interval: 1m
            scrape_timeout: 10s
            metrics_path: /metrics
            scheme: http
            static_configs:
              - targets:
                  - "10.5.0.10:9100"
        selectAllByDefault: true
        scrapeInterval: 25s
        externalLabels:
          cluster: cluster-name
        extraArgs:
          promscrape.streamParse: "true"

    grafana:
      enabled: true
      image:
        repository: docker.io/grafana/grafana
        # renovate: datasource=docker depName=grafana/grafana
        tag: 10.1.2
      extraInitContainers:
        - name: init-db
          image: ghcr.io/onedr0p/postgres-initdb:14.8
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: grafana-secret
      plugins:
        - marcusolsson-json-datasource
      env:
        GF_ANALYTICS_CHECK_FOR_UPDATES: false
        GF_AUTH_OAUTH_ALLOW_INSECURE_EMAIL_LOOKUP: true
        GF_AUTH_GENERIC_OAUTH_API_URL: https://auth.milojevic.dev/api/oidc/userinfo
        GF_AUTH_GENERIC_OAUTH_AUTH_URL: https://auth.milojevic.dev/api/oidc/authorization
        GF_AUTH_GENERIC_OAUTH_CLIENT_ID: grafana
        GF_AUTH_GENERIC_OAUTH_TOKEN_URL: https://auth.milojevic.dev/api/oidc/token
        GF_DATE_FORMATS_USE_BROWSER_LOCALE: true
        GF_EXPLORE_ENABLED: true
        GF_GRAFANA_NET_URL: https://grafana.net
        GF_LOG_FILTERS: rendering:debug
        GF_LOG_MODE: console
        GF_PANELS_DISABLE_SANITIZE_HTML: true
        GF_SECURITY_ALLOW_EMBEDDING: true
        GF_SECURITY_COOKIE_SAMESITE: grafana
        GF_SERVER_ROOT_URL: https://grafana.milojevic.dev
      envFromSecrets:
        - name: grafana-secret
      grafana.ini:
        auth:
          signout_redirect_url: https://auth.milojevic.dev/logout
          oauth_auto_login: false
        auth.generic_oauth:
          enabled: true
          name: Authelia
          client_id: # Set by env vars
          client_secret: # Set by env vars secret
          auth_url: # Set by env vars
          token_url: # Set by env vars
          api_url: # Set by env vars
          scopes: "openid profile email groups"
          empty_scopes: false
          login_attribute_path: preferred_username
          groups_attribute_path: groups
          name_attribute_path: name
          use_pkce: true
        auth.generic_oauth.group_mapping:
          role_attribute_path: |
            contains(groups[*], 'admins') && 'Admin' || contains(groups[*], 'people') && 'Viewer'
          org_id: 1
        auth.basic:
          enabled: false
          # disable_login_form: false
      ## ForceDeployDatasource Create datasource configmap even if grafana deployment has been disabled
      forceDeployDatasource: false

      ## Configure additional grafana datasources (passed through tpl)
      ## ref: http://docs.grafana.org/administration/provisioning/#datasources
      additionalDataSources:
        - name: loki
          orgId: 1
          type: loki
          url: http://loki:3100
          version: 1

      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
            - name: "default"
              orgId: 1
              folder: ""
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/default

      dashboards:
        default:
          nodeexporter:
            gnetId: 1860
            revision: 22
            datasource: VictoriaMetrics
          smartmon:
            gnetId: 10530
            revision: 1
            datasource: VictoriaMetrics

      sidecar:
        datasources:
          enabled: true
          searchNamespace: ALL
        dashboards:
          enabled: true
          searchNamespace: ALL
      defaultDashboardsEnabled: true

      ingress:
        enabled: true
        ingressClassName: nginx
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
        path: /
        pathType: Prefix
        hosts:
          - &host grafana.milojevic.dev
        tls:
          - secretName: milojevic-dev-tls
            hosts:
              - *host

      vmServiceScrape:
        enabled: true

    prometheus-node-exporter:
      enabled: true

      podLabels:
        jobLabel: node-exporter
      extraArgs:
        - --collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/.+)($|/)
        - --collector.filesystem.ignored-fs-types=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$

      vmServiceScrape:
        enabled: true
        # spec for VMServiceScrape crd
        # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmservicescrapespec
        spec:
          jobLabel: jobLabel
          endpoints:
            - port: metrics
              metricRelabelConfigs:
                - action: drop
                  source_labels: [mountpoint]
                  regex: "/var/lib/kubelet/pods.+"
    kube-state-metrics:
      enabled: true
      # spec for VMServiceScrape crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmservicescrapespec
    kubelet:
      enabled: true
      cadvisor: true
      probes: true
      # spec for VMNodeScrape crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmnodescrapespec
      spec:
        scheme: "https"
        honorLabels: true
        interval: "30s"
        scrapeTimeout: "5s"
        tlsConfig:
          insecureSkipVerify: true
          caFile: "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
        bearerTokenFile: "/var/run/secrets/kubernetes.io/serviceaccount/token"
        # drop high cardinality label and useless metrics for cadvisor and kubelet
        metricRelabelConfigs:
          - action: labeldrop
            regex: (uid)
          - action: labeldrop
            regex: (id|name)
          - action: drop
            source_labels: [__name__]
            regex: (rest_client_request_duration_seconds_bucket|rest_client_request_duration_seconds_sum|rest_client_request_duration_seconds_count)
        relabelConfigs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - sourceLabels: [__metrics_path__]
            targetLabel: metrics_path
          - targetLabel: "job"
            replacement: "kubelet"

    # -- Component scraping the kube api server
    kubeApiServer:
      enabled: true
      # spec for VMServiceScrape crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmservicescrapespec
      spec:
        endpoints:
          - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
            # bearerTokenSecret:
            #   key: ""
            port: https
            scheme: https
            tlsConfig:
              caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              serverName: kubernetes
        jobLabel: component
        namespaceSelector:
          matchNames:
            - default
        selector:
          matchLabels:
            component: apiserver
            provider: kubernetes

    # -- Component scraping the kube controller manager
    kubeControllerManager:
      enabled: true

      ## If your kube controller manager is not deployed as a pod, specify IPs it can be found on
      ##
      endpoints: []
      # - 10.141.4.22
      # - 10.141.4.23
      # - 10.141.4.24

      ## If using kubeControllerManager.endpoints only the port and targetPort are used
      ##
      service:
        enabled: true
        port: 10252
        targetPort: 10252
        # selector:
        #   component: kube-controller-manager

      # spec for VMServiceScrape crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmservicescrapespec
      spec:
        jobLabel: jobLabel
        endpoints:
          - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
            # bearerTokenSecret:
            #   key: ""
            port: http-metrics
            scheme: https
            tlsConfig:
              caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              serverName: kubernetes

    # -Component scraping kubeDns. Use either this or coreDns
    kubeDns:
      enabled: false
      service:
        enabled: false
        dnsmasq:
          port: 10054
          targetPort: 10054
        skydns:
          port: 10055
          targetPort: 10055
        selector:
          k8s-app: kube-dns
      # spec for VMServiceScrape crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmservicescrapespec
      spec:
        endpoints:
          - port: http-metrics-dnsmasq
            bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
          - port: http-metrics-skydns
            bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token

    # -- Component scraping coreDns. Use either this or kubeDns
    coreDns:
      enabled: true
      service:
        enabled: true
        port: 9153
        targetPort: 9153
        selector:
          k8s-app: kube-dns

      # spec for VMServiceScrape crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmservicescrapespec
      spec:
        endpoints:
          - port: http-metrics
            bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token

    ## Component scraping etcd
    ##
    kubeEtcd:
      enabled: true

      ## If your etcd is not deployed as a pod, specify IPs it can be found on
      ##
      endpoints: []
      # - 10.141.4.22
      # - 10.141.4.23
      # - 10.141.4.24

      ## Etcd service. If using kubeEtcd.endpoints only the port and targetPort are used
      ##
      service:
        enabled: true
        port: 2379
        targetPort: 2379
        # selector:
        #   component: etcd

      # spec for VMServiceScrape crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmservicescrapespec
      spec:
        jobLabel: jobLabel
        endpoints:
          - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
            # bearerTokenSecret:
            #   key: ""
            port: http-metrics
            scheme: https
            tlsConfig:
              caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt

    ## Component scraping kube scheduler
    ##
    kubeScheduler:
      enabled: true

      ## If your kube scheduler is not deployed as a pod, specify IPs it can be found on
      ##
      endpoints: []
      # - 10.141.4.22
      # - 10.141.4.23
      # - 10.141.4.24

      ## If using kubeScheduler.endpoints only the port and targetPort are used
      ##
      service:
        enabled: true
        port: 10251
        targetPort: 10251
        # selector:
        #   component: kube-scheduler

      # spec for VMServiceScrape crd
      # https://github.com/VictoriaMetrics/operator/blob/master/docs/api.MD#vmservicescrapespec
      spec:
        jobLabel: jobLabel
        endpoints:
          - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
            # bearerTokenSecret:
            #   key: ""
            port: http-metrics
            scheme: https
            tlsConfig:
              caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
