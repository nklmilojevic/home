---
data_dir: /vector-data-dir
api:
  enabled: true
  address: 0.0.0.0:8686

enrichment_tables:
  geoip_table:
    type: geoip
    path: /usr/share/GeoIP/GeoLite2-City.mmdb

#
# Sources
#

sources:
  journald_source:
    type: vector
    version: "2"
    address: 0.0.0.0:6000

  kubernetes_source:
    type: vector
    version: "2"
    address: 0.0.0.0:6010

#
# Transforms
#

transforms:
  kubernetes_remap:
    type: remap
    inputs: ["kubernetes_source"]
    source: |
      # Standardize 'app' index
      .custom_app_name = .pod_labels."app.kubernetes.io/name" || .pod_labels.app || .pod_labels."k8s-app" || "unknown"
      # Drop pod_labels
      del(.pod_labels)

#
# Sinks
#

sinks:
  # journald:
  #   inputs: ["journald_source"]
  #   type: elasticsearch
  #   endpoint: http://vm-logs-victoria-logs-single-server.monitoring.svc:9428/insert/elasticsearch/
  #   encoding: { codec: json }
  #   mode: "bulk"
  #   api_version: "v8"
  #   labels:
  #     hostname: "{{ host }}"

  kubernetes:
    inputs: ["kubernetes_remap"]
    type: elasticsearch
    endpoints:
      - http://vm-logs-victoria-logs-single-server.monitoring.svc:9428/insert/elasticsearch/
    mode: "bulk"
    compression: gzip
    api_version: "v8"
    healthcheck:
      enabled: false
    query:
      _msg_field: "message"
      _time_field: "ts"
      _stream_fields: "host,container_name,custom_app_name,kubernetes.node.name"
      debug: "1"
